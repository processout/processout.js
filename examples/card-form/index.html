<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8" />
    <title>ProcessOut.js Card Form</title>
    <link rel="stylesheet" href="./styles.css" />
  </head>
  <body>
    <div class="container">
      <form action="" method="POST" id="card-form">
        <input type="text" placeholder="John Smith" id="card-form-name" class="form-input" />
        <div
          class="form-input"
          data-processout-input="cc-number"
          data-processout-placeholder="4242 4242 4242 4242"
        ></div>
        <div class="form-input-group">
          <div
            class="form-input"
            data-processout-input="cc-exp"
            data-processout-placeholder="MM / YY"
          ></div>
          <div
            class="form-input"
            data-processout-input="cc-cvc"
            data-processout-placeholder="CVC"
          ></div>
        </div>
        <button type="submit" class="submit-button">Pay</button>
        <div className="form-messages">
          <div id="errors"></div>
          <div id="success"></div>
        </div>
      </form>
    </div>
    <script src="../../dist/processout.js" crossorigin="anonymous"></script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // You need to replace these values with your own
        const projectId = "test-proj_qEi1u5BwoYcZb6mOMKDWIm4mpqKCq6bN"
        const invoiceId = "iv_5pKzE0HKcubbPLklZ7iAHvN2LThuzx8j"

        const client = new ProcessOut.ProcessOut(projectId)
        const formElement = document.getElementById("card-form")

        client.setupForm(
          formElement,
          {
            style: {
              fontSize: "14px",
              "::placeholder": {
                color: "#ababab",
              },
            },
          },
          function (form) {
            let preferredCardType = null;
            form.getNumberField().on("input", function (e) {
              if (e.card_number_length == 6) {
                client.getCardInformation(
                  e.card_iin,
                  function(cardInfo) {
                    // Check for combo card types and display radio buttons if they exist
                    if (cardInfo.combo_card_types && Array.isArray(cardInfo.combo_card_types) && cardInfo.combo_card_types.length > 0) {
                      // Create radio button group
                      const radioGroup = document.createElement('div')
                      radioGroup.className = 'combo-card-types'
                      radioGroup.style.cssText = 'margin: 15px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; background: #f9f9f9;'
                      
                      radioGroup.innerHTML = `
                        <h4 style="margin: 0 0 10px 0; color: #333;">Select Card Type:</h4>
                        ${cardInfo.combo_card_types.map((type, index) => `
                          <label style="display: block; margin: 8px 0; cursor: pointer;">
                            <input type="radio" name="cardType" value="${type}" ${index === 0 ? 'checked' : ''} style="margin-right: 8px;">
                            <span style="text-transform: capitalize; font-weight: 500;">${type}</span>
                          </label>
                        `).join('')}
                      `
                      
                      // Insert before the Pay button
                      const payButton = document.querySelector('.submit-button')
                      payButton.parentNode.insertBefore(radioGroup, payButton)
                      
                      // Add event listener to track selection changes
                      const radioButtons = radioGroup.querySelectorAll('input[name="cardType"]')
                      radioButtons.forEach(radio => {
                        radio.addEventListener('change', function() {
                          preferredCardType = this.value
                          console.log("User selected card type:", preferredCardType)
                        })
                      })
                      
                      // Set initial value
                      preferredCardType = null
                    }
                  },
                  function(err) {
                    console.log("Something went wrong", err)
                  }
                )
              }
    
              document.getElementById("errors").innerHTML = ""
            })

            form.getNumberField().on("focus", function (e) {
              document.getElementById("errors").innerHTML = ""
            })

            form.getExpiryField().on("focus", function (e) {
              document.getElementById("errors").innerHTML = ""
            })

            form.getCVCField().on("focus", function (e) {
              document.getElementById("errors").innerHTML = ""
            })

            form.addEventListener("submit", function (e) {
              e.preventDefault()

              client.tokenize(
                form,
                {
                  name: document.getElementById("card-form-name").value,
                  zip: "10018",
                  preferred_card_type: preferredCardType
                },
                function (token) {
                  console.log("Tokenization Success", token)

                  client.makeCardPayment(
                    invoiceId,
                    token,
                    {
                      authorize_only: true,
                    },
                    function (iv) {
                      console.log("Payment Success")
                    },
                    function (err) {
                      console.log("Payment Error", err)
                    },
                  )
                },
                function (err) {
                  console.log("Tokenization Error", err)
                },
              )

              return false
            })
          },
          function (err) {
            console.log("Setup Form Error", err)
          },
        )
      })
    </script>
  </body>
</html>
